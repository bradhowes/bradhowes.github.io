<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Dependency Injection for iOS in Swift | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Documents how I implemented dependency injection in a Swift iOS project"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/dependencyInjection/dependency-injection.png)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Dependency Injection for iOS in Swift</a></h1><section class=post-meta><time class=post-date datetime="Sat Oct 08 2016 12:18:02 GMT+0200 (Central European Summer Time)">Oct 8th, 2016</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/dependency-injection.html>Dependency Injection (1)</a> • <a class=post-date href=/topics/swift.html>Swift (10)</a> • <a class=post-date href=/topics/ui.html>UI (5)</a></section></header><section class=post-content><p>A powerful concept in modern software design is <em>dependency injection</em> <sup class=footnote-ref><a href=#fn1 id=fnref1>[1]</a></sup>. Basically, it holds that an instance should never create any dependencies internally, but rather provide an interface that allows for installation or <em>injection</em> of relationships from outside of the object. For example, in the code below an instance of class <code>Foo</code> is held inside of class <code>Bar</code>, but class <code>Bar</code> has taken on the responsibility of creating the instance.</p><pre class=language-swift><code class=language-swift><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> foo<span class="token punctuation">:</span> <span class="token class-name">Foo</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Though this is fine, the internal construction offers no way to modify the construction behavior of class <code>Foo</code>. Moreover, there is no way to provide a substitute or <em>mock</em> of class <code>Foo</code> which would be very useful when testing the behavior of class <code>Bar</code>. The easiest and safest way to allow this is to remove the construction of <code>Foo</code> from inside <code>Bar</code> and instead provide an already-constructed instance of <code>Foo</code> in the constructor of <code>Bar</code></p><pre class=language-swift><code class=language-swift><span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> foo<span class="token punctuation">:</span> <span class="token class-name">Foo</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>foo<span class="token punctuation">:</span> <span class="token class-name">Foo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>foo <span class="token operator">=</span> foo
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Now we are free to provide whatever we want for <code>Foo</code> in the constructor.</p><p>Unfortunately, this does not work well for iOS views and controllers that are designed in Xcode storyboards and instantiated from bundles when the application runs. The first time a controller is available for manipulation, the iOS platform has already created the instances – there just is no easy way to provide additional values to the constructor at run-time.</p><blockquote><p>There are some libraries around that attempt to overcome these limitations. One in particular, <a href=https://github.com/AliSoftware/Dip>Dip</a> appears to do a really nice job. However, for what I am working on now, I thought it overkill.</p></blockquote><p>For views, we need to inject dependencies into their view controller before they appear. The normal way to do so is in the <code>prepare(for segue:,sender:)</code> method of the current view controller. This works great, but we still need something for the initial view. The best choice is to rely on the application delegate, which has control prior to showing the main view of the application.</p><h2>Protocols / Interfaces</h2><p>In my app, there are four protocols/interfaces that manage specific functionalities:</p><ul><li><code>UserSettingsInterface</code> – settings that the user can set and modify to affect the behavior of the application</li><li><code>RecordingsStoreInterface</code> – manages the creation, updating, and deletion of <code>Recording</code> instances via Core Data</li><li><code>DropboxControllerInterface</code> – handles uploading of data after a recording</li><li><code>RecordingActivityLogicInterface</code> - contains the “business logic” involved in performing a recording</li></ul><p>The application delegate creates instances of these and holds strong references to them so that they will remain alive for the duration of the application.</p><p>Each of the above protocols has an implementation that provides the functionality for the application. The use of protocols however allows us to create synthetic implementations during testing. A test harness creates <em>mock objects</em> that implement the above protocols/interfaces, but which act and respond in a well-defined manner using synthetic data and actions since the goal is to exercise the code under test.</p><p>Here is the protocol for the <code>DropBoxController</code>:</p><pre class=language-swift><code class=language-swift><span class="token keyword">public</span> <span class="token keyword">protocol</span> <span class="token class-name">DropboxControllerInterface</span><span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function-definition function">toggleAccountLinking</span><span class="token punctuation">(</span>viewController<span class="token punctuation">:</span> <span class="token class-name">UIViewController</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>It only defines one method, to enable/disable account linking in the application. There is also an associated <em>dependent</em> protocol – <code>DropboxControllerDependent</code> – which entities in the app can implement to announce that they depend on a <code>DropBoxControllerInterface</code> object.</p><pre class=language-swift><code class=language-swift><span class="token keyword">public</span> <span class="token keyword">protocol</span> <span class="token class-name">DropboxControllerDependent</span><span class="token punctuation">:</span> <span class="token keyword">class</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> dropboxController<span class="token punctuation">:</span> <span class="token class-name">DropboxControllerInterface</span><span class="token operator">!</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token keyword">set</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Though the actual <code>DropboxController</code> class is filled with functionality to work with the Dropbox cloud, the application only needs to work with <code>toggleAccountLinking</code> to gain Dropbox functionality. The protocol effectively hides or abstracts away implementation details for us.</p><h2>Injecting Dependencies</h2><p>The main view of my app contains a <code>UITabBar</code> inside of which reside three other views. The tab bar controller (<code>TabBarController</code>) does not have any custom dependencies, but the views that it contains do, so we must navigate the view controller hierarchy to find those. Here is the code that does just that:</p><pre class=language-swift><code class=language-swift><span class="token keyword">guard</span> <span class="token keyword">let</span> rvc <span class="token operator">=</span> window<span class="token operator">!</span><span class="token punctuation">.</span>rootViewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">TabBarController</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">fatalError</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"expected TabBarController as first view controller"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
rvc<span class="token punctuation">.</span>childViewControllers<span class="token punctuation">.</span>forEach <span class="token punctuation">{</span> viewController <span class="token keyword">in</span>
    <span class="token keyword">let</span> injector <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>viewController<span class="token punctuation">:</span> <span class="token class-name">AnyObject</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tmp <span class="token operator">=</span> viewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">UserSettingsDependent</span> <span class="token punctuation">{</span>
            tmp<span class="token punctuation">.</span>userSettings <span class="token operator">=</span> userSettings
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tmp <span class="token operator">=</span> viewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">RecordingsStoreDependent</span> <span class="token punctuation">{</span>
            tmp<span class="token punctuation">.</span>recordingsStore <span class="token operator">=</span> recordingsStore
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tmp <span class="token operator">=</span> viewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">DropboxControllerDependent</span> <span class="token punctuation">{</span>
            tmp<span class="token punctuation">.</span>dropboxController <span class="token operator">=</span> dropboxController
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token keyword">let</span> tmp <span class="token operator">=</span> viewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">RecordingActivityLogicDependent</span> <span class="token punctuation">{</span>
            tmp<span class="token punctuation">.</span>recordingActivityLogic <span class="token operator">=</span> recordingActivityLogic
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> tmp <span class="token operator">=</span> viewController <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">UINavigationController</span> <span class="token punctuation">{</span>
        <span class="token function">injector</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>topViewController<span class="token operator">!</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">injector</span><span class="token punctuation">(</span>viewController<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>We iterate over the view controllers held by the tab bar controller and we invoke <code>injector()</code> on each to install any declared dependencies. Note that if the controller is a <code>UINavigationController</code> we grab the controller that is the top one since that is ours.</p><p>Here we see the <em>dependent</em> protocols for each of the interface protocols mentioned earlier. If a controller implements a dependent protocol, then it has a property which will accept an object that implements the associated interface protocol. Note that this kind of logic is what a package like <a href=https://github.com/AliSoftware/Dip>Dip</a> will do for you automatically.</p><h2>Segue Injection</h2><p>Another point of injection for view controllers is the <code>prepare(for segue:…)</code> method of a current <code>UIViewController</code> object. This method runs just before a new view appears on the screen, and the current view controller gets a chance to forward pertinent information to the new view controller. My application currently does not have any segues as all of the views appear from tab bar activity.</p><hr class=footnotes-sep><section class=footnotes><ol class=footnotes-list><li id=fn1 class=footnote-item><p>Image adapted from one found at <a href=http://nearsoft.com/admin/wp-content/uploads/2015/10/top-dependency-injection-in-angularjs.jpg>nearsoft’s “Dependency Injection in AngularJS”</a> <a href=#fnref1 class=footnote-backref>↩</a></p></li></ol></section></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Dependency%20Injection%20for%20iOS%20in%20Swift&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2FdependencyInjection%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2FdependencyInjection%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/corePlot/animation.gif)" href=/articles/corePlot/index.html><section class=post><h2>Working with Core Plot</h2><div class=post-meta>Shows how to add and control Core Plot graphs</div></section></a><a class="read-next-story prev" style="background-image: url(/articles/joystick/animation.gif)" href=/articles/joystick/index.html><section class=post><h2>JoyStickView for iOS in Swift</h2><div class=post-meta>Documents how I implemented a joy stick control view for a Swift iOS project</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2016</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>