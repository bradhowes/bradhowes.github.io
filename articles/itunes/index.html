<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Apple iTunes Library Manipulation with Python | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Short discussion on using Python to manipulate the contents of an iTunes Library XML file."><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/itunes/image.png)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Apple iTunes Library Manipulation with Python</a></h1><section class=post-meta><time class=post-date datetime="Mon Jun 26 2017 11:06:00 GMT+0200 (Central European Summer Time)">Jun 26th, 2017</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/applescript.html>AppleScript (1)</a> • <a class=post-date href=/topics/itunes.html>iTunes (1)</a> • <a class=post-date href=/topics/python.html>Python (7)</a> • <a class=post-date href=/topics/xml.html>XML (1)</a></section></header><section class=post-content><p>At home my family uses Apple <em>iTunes</em> and Safari for the majority of our media playing on our TV. This simple setup runs on a 2010 Mac Mini that I purchased prior to us moving to Prague. It has worked very well as a bare-bones media server that the children know how to use without too much support from me. Recently, I decided to try and consolidate onto one mirrored 4TB drive the media that was on two separate drives (one internal, one external).</p><p>To perform the consolidation, I used <a href=https://en.wikipedia.org/wiki/Rsync>rsync</a> to copy from the two source drives to the new big drive. Though normally used to manage file collections among two or more separate machines, it offers a great collection of features for copying locally on the same machine. For instance, the <a href=https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man1/rsync.1.html>macOS version</a> contains the smarts to also sync any metadata and extended file system attributes associated with the media files. Two <code>rsync</code> commands left me with a new disc with all of the media intact and no errors.</p><p>Next, I started up <em>iTunes</em> while holding down the <code>option</code> key in order to bring up a prompt that allowed me to create a new library.</p><p><img src=iTunesLibraryPrompt_960.png title="iTunes Library Prompt" srcset="iTunesLibraryPrompt_480.png 480w,iTunesLibraryPrompt_650.png 650w,iTunesLibraryPrompt_960.png 960w,iTunesLibraryPrompt_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>I then changed some advanced <em>iTunes</em> settings in order to use the new media disc drive and to let <em>iTunes</em> manage its contents. I also enabled the <code>Share iTunes Library XML with other application</code> setting so that I could perform some library manipulation described next.</p><p><img src=iTunesOptions_960.png title="iTunes Advanced Settings" srcset="iTunesOptions_480.png 480w,iTunesOptions_650.png 650w,iTunesOptions_960.png 960w,iTunesOptions_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><h2>Migrating Metadata</h2><p>Since I created a new library above, I no longer had any metadata associated with media content such as play counts or ratings as these are held inside a specific <em>iTunes</em> library file. The next step was to copy over the metadata from the old <em>iTunes</em> library file. The <code>Share iTunes Library XML with other application</code> options mentioned above asks <em>iTunes</em> to generate and update an XML representation of the library. However changes made to this file will <strong>not</strong> appear in <em>iTunes</em>. Instead, one must rely on AppleScript functionality to make any updates to entity metadata (see below).</p><p><a href=https://www.python.org>Python</a> has a built-in library for reading in Apple XML files – <a href=https://docs.python.org/3/library/plistlib.html>plistlib</a>. Although it seems to apply to just <code>plist</code> files (those with a suffix of <code>.plist</code>), it properly handles the <code>.xml</code> file that <em>iTunes</em> creates from its library contents. Using <code>plistlib</code> I was able to create a short script that migrated certain metadata values from the old library to the new one.</p><pre class=language-python><code class=language-python><span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> dstPath<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- loading'</span><span class="token punctuation">,</span> srcPath<span class="token punctuation">)</span>
    srcRoot <span class="token operator">=</span> plistlib<span class="token punctuation">.</span>readPlist<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span>

    srcMap <span class="token operator">=</span> makeSrcMap<span class="token punctuation">(</span>srcRoot<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- found'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>srcMap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'tracks with metadata'</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- loading'</span><span class="token punctuation">,</span> dstPath<span class="token punctuation">)</span>
    dstRoot <span class="token operator">=</span> plistlib<span class="token punctuation">.</span>readPlist<span class="token punctuation">(</span>dstPath<span class="token punctuation">)</span>

    copyAttributes<span class="token punctuation">(</span>dstRoot<span class="token punctuation">,</span> srcMap<span class="token punctuation">)</span>
    plistlib<span class="token punctuation">.</span>writePlist<span class="token punctuation">(</span>dstRoot<span class="token punctuation">,</span> dstPath<span class="token punctuation">)</span>
</code></pre><p>In an <em>iTunes</em> library each media <em>entity</em> (audio, movie, etc) is called a <em>track</em> and is given a unique integer. Unfortunately, these integer values are not the same across libraries. Therefore, I had to generate my own keys using track attributes that would not change across library instances yet would not collide with other tracks in the library. I chose a 5-tuple made up of the following attributes:</p><ul><li><code>Name</code> — track name</li><li><code>Album</code> — collection name where the track resides</li><li><code>Total Time</code> — measure of how long the media is in seconds</li><li><code>Size</code> — measure of how large the media is in bytes</li><li><code>Location</code> — location of the media file</li></ul><p>The <code>Album</code> name protects against duplicate song names from different albums. The <code>Total Time</code> and <code>Size</code> use physical characteristics to further protect against name collisions. Finally the last component of the <code>Location</code> path protects against situations where there are duplicate audio files – something that should probably be cleaned up in the future. Note that only the last component can be assumed to be shared across the libraries; everything else in the path can be different.</p><pre class=language-python><code class=language-python><span class="token keyword">def</span> <span class="token function">makeKey</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Album'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Total Time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Size'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> getTrackFile<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getTrackFile</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    location <span class="token operator">=</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> location <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token keyword">return</span> urlparse<span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><p>Now that I have (hopefully) unique keys that will apply across <em>iTunes</em> libraries, I next build a mapping of these keys and track entities from the source library in order to find them with keys generated from the destination library.</p><pre class=language-python><code class=language-python><span class="token keyword">def</span> <span class="token function">makeSrcMap</span><span class="token punctuation">(</span>srcRoot<span class="token punctuation">)</span><span class="token punctuation">:</span>
    srcMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> trackId<span class="token punctuation">,</span> attributes <span class="token keyword">in</span> srcRoot<span class="token punctuation">[</span><span class="token string">'Tracks'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Genre'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Voice Memo'</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        itemKey <span class="token operator">=</span> makeKey<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> srcMap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>itemKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** duplicate itemKey:'</span><span class="token punctuation">,</span> itemKey<span class="token punctuation">)</span>
            pprint<span class="token punctuation">(</span>srcMap<span class="token punctuation">[</span>itemKey<span class="token punctuation">]</span><span class="token punctuation">)</span>
            pprint<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        srcMap<span class="token punctuation">[</span>itemKey<span class="token punctuation">]</span> <span class="token operator">=</span> attributes
    <span class="token keyword">return</span> srcMap
</code></pre><p>(the check for “Voice Memo” <code>Genre</code> attribute removes collisions I had with voice memos from an iPhone — this was the easiest way to deal with them)</p><h2>AppleScript and Python</h2><p>A long time ago, I made my own Python server to drive a <a href=http://wiki.slimdevices.com/index.php/SLIMP3>SLiMP3</a> device. The server (code available <a href=https://github.com/bradhowes/pyslimp3>here</a>) parsed the <em>iTunes</em> library XML file to figure out what audio files were available, and it used AppleScript to control <em>iTunes</em>. To bridge between Python and AppleScript, the server relied on a wonderful package called <a href=http://appscript.sourceforge.net>appscript</a>. Although development on <em>appscript</em> <a href=http://appscript.sourceforge.net/status.html>stopped in 2012</a>, amazingly it still works on my macOS Sierra (10.12.5) MacBook Pro.</p><p>Interacting with <em>iTunes</em> via <em>appscript</em> is surprisingly simple though there are times when lack of documentation makes for rough going. First, to get access to the library of media tracks in <em>iTunes</em>:</p><pre class=language-python><code class=language-python><span class="token keyword">import</span> appscript
app <span class="token operator">=</span> appscript<span class="token punctuation">.</span>app<span class="token punctuation">(</span><span class="token string">'iTunes'</span><span class="token punctuation">)</span>
lib <span class="token operator">=</span> app<span class="token punctuation">.</span>library_playlists<span class="token punctuation">[</span><span class="token string">'Library'</span><span class="token punctuation">]</span>
</code></pre><p>To get a subset of tracks, one needs to provide one or more criteria that tells <em>iTunes</em> which tracks to chose from all in the library. For instance, to get tracks with names containing the word 'Alien’:</p><pre class=language-python><code class=language-python><span class="token operator">>></span><span class="token operator">></span> found <span class="token operator">=</span> lib<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>appscript<span class="token punctuation">.</span>its<span class="token punctuation">.</span>name<span class="token punctuation">.</span>contains<span class="token punctuation">(</span><span class="token string">'Alien'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token punctuation">[</span>z<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> z <span class="token keyword">in</span> found<span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">u'Sounds Alien'</span><span class="token punctuation">,</span> <span class="token string">u'Alien Heart'</span><span class="token punctuation">,</span> <span class="token string">u'I Want An Alien For Christmas'</span><span class="token punctuation">,</span> <span class="token string">u'Praying to the Aliens'</span><span class="token punctuation">,</span> u'Subterranean Homesick A\
lien<span class="token string">', u"Alien: The Director'</span>s Cut"<span class="token punctuation">,</span> <span class="token string">u'Alien'</span><span class="token punctuation">,</span> <span class="token string">u'Alien (Bonus Track)'</span><span class="token punctuation">,</span> <span class="token string">u'I Thought I Was an Alien'</span><span class="token punctuation">,</span> <span class="token string">u'Amalienbad'</span><span class="token punctuation">,</span> u'Vi\
a Caliente'<span class="token punctuation">]</span>
</code></pre><p>Note that trailing <code>get()</code> call causes the query to execute in the <em>iTunes</em> app. Before that, what is held locally is a pending AppleEvent expression (which can be quite complex). We can create a similar query to get the track we want to update by looking for the <code>Track ID</code> found in the XML file. The corresponding AppleEvent property to compare against is <code>database_ID</code>.</p><pre class=language-python><code class=language-python>tracks <span class="token operator">=</span> lib<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>appscript<span class="token punctuation">.</span>its<span class="token punctuation">.</span>database_ID <span class="token operator">==</span> attributes<span class="token punctuation">[</span><span class="token string">'Track ID'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tracks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
    track <span class="token operator">=</span> track<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    track <span class="token operator">=</span> <span class="token number">0</span>
</code></pre><p>Here we fetch from <em>iTunes</em> the track(s) with the given <code>Track ID</code> value in their <code>database_ID</code> property. If we get anything but an array of one element, we assign <code>0</code> to the <code>track</code> variable as a signal that there is no track to work with.</p><p>Next, we handle each attribute with a custom <em>iTunes</em> AppleEvent <code>set</code> command. There are three kinds of settings we look for and apply:</p><ul><li>Play/Skip counts and the date of the last play or skip if the count is non-zero</li><li>User ratings — integer values between 0 and 100 inclusive for a track or an album</li><li>Loved/Disliked flags — Boolean values assigned to a track or an album (NOTE: these are not always available)</li></ul><p>Play and skip counts are handled in the same way, though the date of the last play has an unusual name since there was a legacy read-only ‘Play Date’ attribute in the XML schema. For ratings, we only set a value if there is not an associated <em>computed</em> property with a <code>true</code> value, which would indicate that the rating value was not set by the user but rather calculated by <em>iTunes</em>.</p><pre class=language-python><code class=language-python><span class="token keyword">if</span> <span class="token string">'Count'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
    <span class="token keyword">if</span> tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        attributeName <span class="token operator">=</span> attributeName<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' Date'</span>
        <span class="token keyword">if</span> attributeName<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'Play'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            attributeName <span class="token operator">+=</span> <span class="token string">' UTC'</span>
        tmp <span class="token operator">=</span> srcItem<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span>
        <span class="token keyword">if</span> tmp <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span>

<span class="token keyword">elif</span> <span class="token string">'Rating'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
    <span class="token keyword">if</span> srcItem<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attributeName <span class="token operator">+</span> <span class="token string">' Computed'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>

<span class="token keyword">elif</span> <span class="token string">'Loved'</span> <span class="token keyword">in</span> attributeName <span class="token keyword">or</span> <span class="token string">'Disliked'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">.</span>attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token keyword">except</span> AttributeError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** track has no attribute "{}"'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><h2>Full Script</h2><p><a href=merge.py>Here</a> in full is the script that I used. To run from the command line:</p><pre class=language-console><code class=language-console><span class=command-line-prompt><span data-prompt=%></span></span><span class=command-line-command>python merge.py SRC DST</span></code></pre><p>where <code>SRC</code> is the path to the source library XML file and <code>DST</code> is the path to the destination library XML file.</p><pre class=language-python><code class=language-python><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function
<span class="token keyword">import</span> appscript<span class="token punctuation">,</span> plistlib<span class="token punctuation">,</span> sys
<span class="token keyword">from</span> pprint <span class="token keyword">import</span> pprint
<span class="token keyword">from</span> urlparse <span class="token keyword">import</span> urlparse

<span class="token comment"># Mapping from XML attribute to iTunes track properties</span>
<span class="token comment">#</span>
attributeMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'Play Count'</span><span class="token punctuation">:</span> <span class="token string">'played_count'</span><span class="token punctuation">,</span>
                <span class="token string">'Play Date UTC'</span><span class="token punctuation">:</span> <span class="token string">'played_date'</span><span class="token punctuation">,</span>
                <span class="token string">'Skip Count'</span><span class="token punctuation">:</span> <span class="token string">'skipped_count'</span><span class="token punctuation">,</span>
                <span class="token string">'Skip Date'</span><span class="token punctuation">:</span> <span class="token string">'skipped_date'</span><span class="token punctuation">,</span>
                <span class="token string">'Rating'</span><span class="token punctuation">:</span> <span class="token string">'rating'</span><span class="token punctuation">,</span>
                <span class="token string">'Album Rating'</span><span class="token punctuation">:</span> <span class="token string">'album_rating'</span><span class="token punctuation">,</span>
                <span class="token string">'Loved'</span><span class="token punctuation">:</span> <span class="token string">'loved'</span><span class="token punctuation">,</span>
                <span class="token string">'Album Loved'</span><span class="token punctuation">:</span> <span class="token string">'album_loved'</span><span class="token punctuation">,</span>
                <span class="token string">'Disliked'</span><span class="token punctuation">:</span> <span class="token string">'disliked'</span><span class="token punctuation">,</span>
                <span class="token string">'Album Disliked'</span><span class="token punctuation">:</span> <span class="token string">'album_disliked'</span>
<span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">tryAESet</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        ae <span class="token operator">=</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
        ae<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>
    <span class="token keyword">except</span> AttributeError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** failed: track has no property "{}"'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> appscript<span class="token punctuation">.</span>reference<span class="token punctuation">.</span>commandError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** failed:'</span><span class="token punctuation">,</span> err<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>errormessage<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">False</span>

<span class="token keyword">def</span> <span class="token function">getTrackFile</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    location <span class="token operator">=</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Location'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> location <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> <span class="token keyword">return</span> <span class="token string">''</span>
    <span class="token keyword">return</span> urlparse<span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">makeKey</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Album'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Total Time'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Size'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> getTrackFile<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">makeSrcMap</span><span class="token punctuation">(</span>srcRoot<span class="token punctuation">)</span><span class="token punctuation">:</span>
    srcMap <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> trackId<span class="token punctuation">,</span> attributes <span class="token keyword">in</span> srcRoot<span class="token punctuation">[</span><span class="token string">'Tracks'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Genre'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Voice Memo'</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        itemKey <span class="token operator">=</span> makeKey<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
        <span class="token keyword">if</span> srcMap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>itemKey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** duplicate itemKey:'</span><span class="token punctuation">,</span> itemKey<span class="token punctuation">)</span>
            pprint<span class="token punctuation">(</span>srcMap<span class="token punctuation">[</span>itemKey<span class="token punctuation">]</span><span class="token punctuation">)</span>
            pprint<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        srcMap<span class="token punctuation">[</span>itemKey<span class="token punctuation">]</span> <span class="token operator">=</span> attributes
    <span class="token keyword">return</span> srcMap

<span class="token keyword">def</span> <span class="token function">copyAttributes</span><span class="token punctuation">(</span>dstRoot<span class="token punctuation">,</span> srcMap<span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> appscript<span class="token punctuation">.</span>app<span class="token punctuation">(</span><span class="token string">'iTunes'</span><span class="token punctuation">)</span>
    lib <span class="token operator">=</span> app<span class="token punctuation">.</span>library_playlists<span class="token punctuation">[</span><span class="token string">'Library'</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> trackId<span class="token punctuation">,</span> attributes <span class="token keyword">in</span> dstRoot<span class="token punctuation">[</span><span class="token string">'Tracks'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> attributes<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'Genre'</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'Voice Memo'</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>

        itemKey <span class="token operator">=</span> makeKey<span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
        srcItem <span class="token operator">=</span> srcMap<span class="token punctuation">.</span>get<span class="token punctuation">(</span>itemKey<span class="token punctuation">)</span>
        <span class="token keyword">if</span> srcItem <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            changed <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            track <span class="token operator">=</span> <span class="token boolean">None</span>
            <span class="token keyword">for</span> attributeName <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'Play Count'</span><span class="token punctuation">,</span> <span class="token string">'Skip Count'</span><span class="token punctuation">,</span>
                                  <span class="token string">'Rating'</span><span class="token punctuation">,</span> <span class="token string">'Album Rating'</span><span class="token punctuation">,</span>
                                  <span class="token string">'Loved'</span><span class="token punctuation">,</span> <span class="token string">'Album Loved'</span><span class="token punctuation">,</span>
                                  <span class="token string">'Disliked'</span><span class="token punctuation">,</span> <span class="token string">'Album Disliked'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                value <span class="token operator">=</span> srcItem<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span>
                <span class="token keyword">if</span> value <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> track <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> track <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                        tracks <span class="token operator">=</span> lib<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>appscript<span class="token punctuation">.</span>its<span class="token punctuation">.</span>database_ID <span class="token operator">==</span> attributes<span class="token punctuation">[</span><span class="token string">'Track ID'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tracks<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                            track <span class="token operator">=</span> tracks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                        <span class="token keyword">else</span><span class="token punctuation">:</span>
                            track <span class="token operator">=</span> <span class="token number">0</span>

                    changed<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>attributeName<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span>

                    <span class="token keyword">if</span> <span class="token string">'Count'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
                        <span class="token keyword">if</span> tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
                            attributeName <span class="token operator">=</span> attributeName<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' Date'</span>
                            <span class="token keyword">if</span> attributeName<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'Play'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                                attributeName <span class="token operator">+=</span> <span class="token string">' UTC'</span>
                            tmp <span class="token operator">=</span> srcItem<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span>
                            <span class="token keyword">if</span> tmp <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                                tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> tmp<span class="token punctuation">)</span>

                    <span class="token keyword">elif</span> <span class="token string">'Rating'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
                        <span class="token keyword">if</span> srcItem<span class="token punctuation">.</span>get<span class="token punctuation">(</span>attributeName <span class="token operator">+</span> <span class="token string">' Computed'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                            tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">,</span> attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>

                    <span class="token keyword">elif</span> <span class="token string">'Loved'</span> <span class="token keyword">in</span> attributeName <span class="token keyword">or</span> <span class="token string">'Disliked'</span> <span class="token keyword">in</span> attributeName<span class="token punctuation">:</span>
                        <span class="token keyword">try</span><span class="token punctuation">:</span>
                            tryAESet<span class="token punctuation">(</span>track<span class="token punctuation">.</span>attributeMap<span class="token punctuation">[</span>attributeName<span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
                        <span class="token keyword">except</span> AttributeError <span class="token keyword">as</span> err<span class="token punctuation">:</span>
                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'*** track has no attribute "{}"'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>attributeName<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- updated'</span><span class="token punctuation">,</span> itemKey<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> changed<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">merge</span><span class="token punctuation">(</span>srcPath<span class="token punctuation">,</span> dstPath<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- loading'</span><span class="token punctuation">,</span> srcPath<span class="token punctuation">)</span>
    srcRoot <span class="token operator">=</span> plistlib<span class="token punctuation">.</span>readPlist<span class="token punctuation">(</span>srcPath<span class="token punctuation">)</span>

    srcMap <span class="token operator">=</span> makeSrcMap<span class="token punctuation">(</span>srcRoot<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- found'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>srcMap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'tracks with metadata'</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-- loading'</span><span class="token punctuation">,</span> dstPath<span class="token punctuation">)</span>
    dstRoot <span class="token operator">=</span> plistlib<span class="token punctuation">.</span>readPlist<span class="token punctuation">(</span>dstPath<span class="token punctuation">)</span>

    copyAttributes<span class="token punctuation">(</span>dstRoot<span class="token punctuation">,</span> srcMap<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    merge<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Apple%20iTunes%20Library%20Manipulation%20with%20Python&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fitunes%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fitunes%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/metalsmith2/computer-keyboard-stones-on-grass-background-header.jpg)" href=/articles/metalsmith2/index.html><section class=post><h2>Metalsmith Plugins for Server-side KaTeX Processing</h2><div class=post-meta>Brief description of updates I&#x27;ve made to my blog rendering tool-chain to remove in-browser KaTeX processing</div></section></a><a class="read-next-story prev" style="background-image: url(/articles/autohotkey/banner.png)" href=/articles/autohotkey/index.html><section class=post><h2>Different (Key)strokes for Different Folks</h2><div class=post-meta>Short discussion on how I configured AutoHotKey to minimize my typing errors in Windows.</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2017</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>