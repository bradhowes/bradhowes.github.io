<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Remarkable Customizations | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="How I customized Remarkable to get what I wanted"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/images/computer-keyboard-stones-on-grass-background-header.jpg)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Remarkable Customizations</a></h1><section class=post-meta><time class=post-date datetime="Sun Apr 12 2020 02:10:02 GMT+0200 (Central European Summer Time)">Apr 12th, 2020</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/javascript.html>Javascript (5)</a> • <a class=post-date href=/topics/markdown.html>Markdown (4)</a> • <a class=post-date href=/topics/remarkable.html>Remarkable (4)</a> • <a class=post-date href=/topics/svg.html>SVG (2)</a></section></header><section class=post-content><p>The <a href=https://github.com/jonschlinkert/remarkable>Remarkable</a> processor for Markdown is great way to render Markdown text into HTML, especially for something like a static site generator such as the one I crafted to make this site. But it does have some minor limitations. First, the <em>fence</em> block processing is a tad too limiting for my tastes. In particular, I was not easily able to adapt it to use <a href=https://prismjs.com>Prism</a> for highlighting code or console output. I could get it to run OK from within the user’s browser, but the whole point of having a static site is to minimize them amount of processing done by the reader.</p><p>Here is the snippet of code from my <a href=https://github.com/bradhowes/keystrokecountdown/blob/master/build.js>build.js</a> file that initializes the Remarkable object that does the Markdown processing:</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> md <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Remarkable</span><span class="token punctuation">(</span><span class="token string">"full"</span><span class="token punctuation">,</span> markdownOptions<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>katexPlugin<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./codeFence.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./consoleFence.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./graphFence.js"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>The KaTex plugin is one I wrote – see <a href=https://github.com/bradhowes/remarkable-katex>Remarkable KaTeX</a>. The other three custom <code>use</code> injections pull in files local to the <code>build.js</code> file. These are described below.</p><h2>Custom Static Prism Highlighting</h2><p>Below is my adaptation of the <em>fence</em> function that resides in Remarkable. This function detects <em>fence</em> blocks: a collection of lines that begin and end with the sequence ``` (three backticks), like so:</p><pre><code>```
This is the first line of the block
This is the second line of the block
This is the last line of the block
```
</code></pre><p>Fence blocks are most often used to render code, usually in a monospace font and perhaps with some colorizing to keep things interesting.</p><p>My function simply enables highlighing of fenced text before adding it to the rendered output. Since it usually involves code, I put it in the <code>codeFence.js</code> file, but this is more of a misnomer since it applies to all fence blocks that are not handled by another fence type handler (see below).</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> escapeHtml <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./escapeHtml.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Tweaked version of stock Remarkable code fence renderer that works with Prism as a highlighter.</span>
<span class="token comment">//</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">md<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function-variable function">fence</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> langPrefix <span class="token operator">=</span> options<span class="token punctuation">.</span>langPrefix<span class="token punctuation">;</span>

    <span class="token keyword">let</span> langName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> fences<span class="token punctuation">,</span> langClass <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// ```foo bar</span>
      <span class="token comment">//</span>
      <span class="token comment">// Try custom renderer "foo" first. That will simplify overwrite for diagrams, latex, and any other fenced</span>
      <span class="token comment">// block with custom look</span>
      <span class="token comment">//</span>
      fences <span class="token operator">=</span> token<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>fence_custom<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>fences<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>fence_custom<span class="token punctuation">[</span>fences<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">(</span>tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      langName <span class="token operator">=</span> fences<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      langClass <span class="token operator">=</span> <span class="token string">' class="'</span> <span class="token operator">+</span> langPrefix <span class="token operator">+</span> langName <span class="token operator">+</span> <span class="token string">'"'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> highlighted<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>highlight<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      highlighted <span class="token operator">=</span> options<span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>highlight<span class="token punctuation">,</span> <span class="token punctuation">[</span> token<span class="token punctuation">.</span>content <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>fences<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token operator">||</span> <span class="token function">escapeHtml</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      highlighted <span class="token operator">=</span> <span class="token function">escapeHtml</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token string">'&lt;pre'</span> <span class="token operator">+</span> langClass <span class="token operator">+</span> <span class="token string">'>&lt;code'</span> <span class="token operator">+</span> langClass <span class="token operator">+</span> <span class="token string">'>'</span> <span class="token operator">+</span> highlighted <span class="token operator">+</span> <span class="token string">'&lt;/code>&lt;/pre>\n'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> md<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><h2>Console Output</h2><p>I have a need to show Unix commands and their output in my blog postings. Prism and friends have a nice way to do this – though not without some customization on my part: see <a href=https://keystrokecountdown.com/articles/console/index.html>Formatting Console Output</a>.</p><pre class=language-javascript><code class=language-javascript><span class="token keyword">const</span> escapeHtml <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./escapeHtml.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Custom fence block render used when 'prompt' follows the beginning of the block -- ```prompt</span>
<span class="token comment">//</span>
<span class="token comment">// Emits the contents of the fence block wrapped in &lt;pre> and &lt;code> elements. The &lt;pre> element has classes</span>
<span class="token comment">// `command-line` and `language-console` in order to take advantage of the `command-line` plugin from Prism code</span>
<span class="token comment">// colorizing library. Additional text after the `prompt` tag will appear in the &lt;pre> tag as attributes,</span>
<span class="token comment">// presumably ones that `command-line` understands.</span>
<span class="token comment">//</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">md<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>fence_custom<span class="token punctuation">.</span><span class="token function-variable function">console</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> token<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(^\s+|\s+$)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// strip leading/trailing whitespace</span>
    <span class="token keyword">let</span> lines <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> bits <span class="token operator">=</span> token<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> args <span class="token operator">=</span> bits<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> bits<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> args <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> demo <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"-d"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      args <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      demo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> prompt <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">'%'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lang <span class="token operator">=</span> <span class="token string">'language-'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">?</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> promptOut <span class="token operator">=</span> <span class="token string">'&lt;span data-prompt="'</span> <span class="token operator">+</span> prompt <span class="token operator">+</span> <span class="token string">'">&lt;/span>'</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token string">'&lt;pre class="'</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">'">&lt;code class="'</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">'">&lt;span class="command-line-prompt">'</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> line <span class="token operator">=</span> lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>demo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          output <span class="token operator">=</span> output <span class="token operator">+</span> promptOut<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
          output <span class="token operator">=</span> output <span class="token operator">+</span> <span class="token string">'&lt;span data-prompt=" ">&lt;/span>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prompt<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> prompt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'&lt;span class="command-line-command">'</span> <span class="token operator">+</span> <span class="token function">escapeHtml</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>prompt<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
          <span class="token string">'&lt;/span>'</span><span class="token punctuation">;</span>
        output <span class="token operator">=</span> output <span class="token operator">+</span> promptOut<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token punctuation">{</span>
        lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">escapeHtml</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        output <span class="token operator">=</span> output <span class="token operator">+</span> <span class="token string">'&lt;span data-prompt=" ">&lt;/span>'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> output <span class="token operator">+</span> <span class="token string">'&lt;/span>'</span> <span class="token operator">+</span> lines<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/code>&lt;/pre>'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> md<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>Here’s an example of this fence rendering. First the source:</p><pre><code>```console howes%
howes% ls
one    four   seven
two    five   eight
three  six    nine
howes%
```
</code></pre><p>And now the rendered result:</p><pre class=language-console><code class=language-console><span class=command-line-prompt><span data-prompt=howes%></span><span data-prompt=" "></span><span data-prompt=" "></span><span data-prompt=" "></span><span data-prompt=howes%></span></span><span class=command-line-command>ls</span>
one    four   seven
two    five   eight
three  six    nine
<span class=command-line-command></span></code></pre><h2>Embedded SVG Graphics</h2><p>Sometimes, I wish to draw something in a textual form that I can then render as a pretty picture. Editing the text is fairly easy whereas editing a graphic is much more cumbersome to get into a format that is suitable for the web. Enter the <code>viz.js</code> package (or hack per the author) which brings the power <a href=http://www.graphviz.org>Graphviz</a> to browsers and static site generators.</p><p>A simple example. The following code block:</p><pre><code>```graph Figure 1
digraph {a->b->c;}
```
</code></pre><p>generates the following when rendered:</p><figure class=graph><?xml version="1.0" encoding="UTF-8" standalone="no"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"> <svg width=62pt height=188pt viewBox="0.00 0.00 62.00 188.00" xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink><g id=graph0 class=graph transform="scale(1 1) rotate(0) translate(4 184)"><title>%0</title><polygon fill=#ffffff stroke=transparent points="-4,4 -4,-184 58,-184 58,4 -4,4"/><g id=node1 class=node><title>a</title><ellipse fill=none stroke=#000000 cx=27 cy=-162 rx=27 ry=18 /><text text-anchor=middle x=27 y=-157.8 font-family=Times,serif font-size=14.00 fill=#000000>a</text></g><g id=node2 class=node><title>b</title><ellipse fill=none stroke=#000000 cx=27 cy=-90 rx=27 ry=18 /><text text-anchor=middle x=27 y=-85.8 font-family=Times,serif font-size=14.00 fill=#000000>b</text></g><g id=edge1 class=edge><title>a&#45;&gt;b</title><path fill=none stroke=#000000 d="M27,-143.8314C27,-136.131 27,-126.9743 27,-118.4166"/><polygon fill=#000000 stroke=#000000 points="30.5001,-118.4132 27,-108.4133 23.5001,-118.4133 30.5001,-118.4132"/></g><g id=node3 class=node><title>c</title><ellipse fill=none stroke=#000000 cx=27 cy=-18 rx=27 ry=18 /><text text-anchor=middle x=27 y=-13.8 font-family=Times,serif font-size=14.00 fill=#000000>c</text></g><g id=edge2 class=edge><title>b&#45;&gt;c</title><path fill=none stroke=#000000 d="M27,-71.8314C27,-64.131 27,-54.9743 27,-46.4166"/><polygon fill=#000000 stroke=#000000 points="30.5001,-46.4132 27,-36.4133 23.5001,-46.4133 30.5001,-46.4132"/></g></g></svg><figcaption>Figure 1</figcaption></figure><p>An older version worked just fine, but recent updates made it difficult to use with Remarkable due to how it manages asynchronicity. However, I was able to get it working reasonably well by adding some Promise support to Remarkable and my <code>build.js</code> script. I added a <code>addPromise</code> method to the Remarkable instance which records promises of future rendering output. These are stored under <code>placeholder</code> token which is also injected into the rendered HTML output.</p><pre class="language-javascript const Viz = require('viz.js'); const { Module, render } ="><code class="language-javascript const Viz = require('viz.js'); const { Module, render } ="><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'viz.js/full.render.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Custom fence processor for "```graph" blocks.</span>
<span class="token comment">//</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">md<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>rules<span class="token punctuation">.</span>fence_custom<span class="token punctuation">.</span><span class="token function-variable function">graph</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">tokens<span class="token punctuation">,</span> idx<span class="token punctuation">,</span> options<span class="token punctuation">,</span> env<span class="token punctuation">,</span> instance</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> tokens<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> token<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> viz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Viz</span><span class="token punctuation">(</span><span class="token punctuation">{</span> Module<span class="token punctuation">,</span> render <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> promise <span class="token operator">=</span> viz<span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> placeholder <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">addPromise</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span>content<span class="token punctuation">,</span> promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">'&lt;figure class="graph">'</span> <span class="token operator">+</span> placeholder <span class="token operator">+</span> <span class="token string">'&lt;figcaption>'</span> <span class="token operator">+</span> title <span class="token operator">+</span> <span class="token string">'&lt;/figcaption>&lt;/figure>'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> md<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>In the <code>processMarkdown</code> function of my <code>build.js</code> file, I process all promises with the following:</p><pre class=language-javascript><code class=language-javascript><span class="token comment">// Generate HTML from the Markdown.</span>
<span class="token comment">//</span>
<span class="token keyword">var</span> contents <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>contents<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// If the rendering left any promises, allow them to update the content with their resolved value.</span>
<span class="token comment">//</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">[</span>placeholder<span class="token punctuation">,</span> promise<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    contents <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>placeholder<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Finally, when all promises are done, we update the metadata and signal Metalsmith to continue.</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> allPromise <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>md<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span>promises<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
allPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  data<span class="token punctuation">.</span>contents <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> files<span class="token punctuation">[</span>file<span class="token punctuation">]</span><span class="token punctuation">;</span>
  files<span class="token punctuation">[</span>htmlPath<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
  <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>First, we replace each placeholder value with the actual value from the promise. Next, we wait for all promises to be resolved, and then we update the Metalsmith records with the new HTML output. Finally, we signal Metalsmith that we are done by calling the Metalsmith <code>done</code> sentinal function.</p></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Remarkable%20Customizations&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fremarkable%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fremarkable%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/browsers/browsers.png)" href=/articles/browsers/index.html><section class=post><h2>Automatic Browser Selection</h2><div class=post-meta>Setup on macOS to use Chrome only when at work</div></section></a><a class="read-next-story prev" style="background-image: url(/computer-keyboard-stones-on-grass-background-header.jpg)" href=/articles/wma/index.html><section class=post><h2>Converting WMA Files to MP3</h2><div class=post-meta>Using FFMpeg toolkit to transcode MWA files to MP3 format</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2020</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>