<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Fixing Azure Let&#x27;s Encrypt Expired Key | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Account of what I did to fix a broken Azure Let&#x27;s Encrypt web job"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/letencrypt/computer-keyboard-stones-on-grass-background-header.jpg)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Fixing Azure Let&#x27;s Encrypt Expired Key</a></h1><section class=post-meta><time class=post-date datetime="Sat Mar 17 2018 12:18:02 GMT+0100 (Central European Standard Time)">Mar 17th, 2018</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/azure.html>Azure (3)</a> • <a class=post-date href=/topics/crypto.html>Crypto (2)</a> • <a class=post-date href=/topics/lets-encrypt.html>Lets Encrypt (1)</a></section></header><section class=post-content><blockquote><p>Note to self: do <em>not</em> enable HTTPS-only on the Azure “TLS/SSL settings” for the App Service. This will keep the Let’s Encrypt service from properly updating the certificate.</p></blockquote><p>For the past year, this blog site has supported SSL connections using a certificate provided by the free <a href=https://letsencrypt.org>Let’s Encrypt</a> service. I use the <a href=https://github.com/sjkp/letsencrypt-siteextension>Let’s Encrypt Site Extension</a> created by Simon J.K. Pedersen to do the certificate renewal. It was a bit of a pain to set up, but it has been running flawlessly for a year. Until now.</p><p>Every 3 months, I get an email from Let’s Encrypt notifying me that the certificate I am using from them is about to expire. I create a calendar entry a couple of days prior to the expiration date to check that the renew took place. I was rather suprised when this day arrived and I find that there were errors trying to renew the certificate.</p><p><img src=step0_960.png title="" srcset="step0_480.png 480w,step0_650.png 650w,step0_960.png 960w,step0_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Looking at the error message and stack trace was not too informative, though the words “Invalid client secret” seemed like a good place to start. Google search showed me that it was due to an expired key that the Let’s Encrypt web job held to allow it to access my site’s configuration. Now, I just needed to figure out how to fix this. More Google searching and poking around on the Azure portal finally got things working again. Here are the steps I took to make it so.</p><p>First, I clicked on <em>Azure Active Directory</em> in the portal:</p><p><img src=step1_960.png title="" srcset="step1_480.png 480w,step1_650.png 650w,step1_960.png 960w,step1_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Next, I brought up the <em>App registrations</em> blade:</p><p><img src=step2_960.png title="" srcset="step2_480.png 480w,step2_650.png 650w,step2_960.png 960w,step2_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Note that for me I had to select <em>All apps</em> before I saw anything. Clicking on the <em>Lets Encrypt</em> entry brought up a new panel with general info:</p><p><img src=step3_960.png title="" srcset="step3_480.png 480w,step3_650.png 650w,step3_960.png 960w,step3_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Clicking on <em>Settings</em> brings up a new panel with what we are after: <em>Keys</em></p><p><img src=step4_960.png title="" srcset="step4_480.png 480w,step4_650.png 650w,step4_960.png 960w,step4_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>The <em>Keys</em> panel reveals the source of the problem I was having. When I first installed the Azure Lets Encrypt web job, the maximum expiration time for a key was 1 year. Now, I can create a new one with an <em>infinite</em> expiration time.</p><p><img src=step5_960.png title="" srcset="step5_480.png 480w,step5_650.png 650w,step5_960.png 960w,step5_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Note that the interface for this pane is a <em>pain</em> to understand. Basically, to create a new key enter something in the <em>Key description</em> field, set the desired <em>Duration</em> value, and click on <em>Save</em>. Azure will generate a new value for the key and show it in the VALUE column. <em>Be sure to copy it!</em> – the key will disappear once you dismiss the panel.</p><p>Now we need to update the new key value. The first place is in the app’s <em>Application Settings</em> panel. The new value should appear in <code>_letsencrypt:ClientSecret</code> setting. Be sure to save the update before leaving the panel.</p><p>Next, we need to change the key value used by Azure Let’s Encrypt extension. Go to the Kudu site for your Azure web app (eg https://blahblahblah.scm.azurewebsites.net). From there, click on <em>Site extensions</em>. I only have one, so I get this:</p><p><img src=step6_960.png title="" srcset="step6_480.png 480w,step6_650.png 650w,step6_960.png 960w,step6_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>Click on the <em>play</em> button to show the configuration screen for the site extension. Paste in the new key value in the <em>ClientSecret</em> field, then click on <em>Next</em>. If all goes well, you will get to the “Request and Install Certificate” screen. Select the hostname to update and then click on “Request and Install certificate” button. Hopefully, this is the result:</p><p><img src=step7_960.png title="" srcset="step7_480.png 480w,step7_650.png 650w,step7_960.png 960w,step7_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Fixing%20Azure%20Let&#x27;s%20Encrypt%20Expired%20Key&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fletencrypt%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fletencrypt%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/console/zscr2.png)" href=/articles/console/index.html><section class=post><h2>Formatting Console Output</h2><div class=post-meta>Short discussion on how I updated my blog to show formatted console output</div></section></a><a class="read-next-story prev" style="background-image: url(/images/computer-keyboard-stones-on-grass-background-header.jpg)" href=/articles/keymaps/index.html><section class=post><h2>Remapping Keys on macOS High Sierra</h2><div class=post-meta>Short discussion on how I remapped the keys on my MacBook Pro w/ an international layout.</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2018</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>