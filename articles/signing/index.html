<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Signing Embedded Frameworks in an Embedded Framework | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Short discussion about an issue I had using an embedded framework that itself contained embedded frameworks"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/signing/image.png)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Signing Embedded Frameworks in an Embedded Framework</a></h1><section class=post-meta><time class=post-date datetime="Tue Feb 14 2017 12:18:02 GMT+0100 (Central European Standard Time)">Feb 14th, 2017</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/swift.html>Swift (10)</a> • <a class=post-date href=/topics/xcode.html>Xcode (2)</a></section></header><section class=post-content><p>I have been working on a feature for a mobile application that was developed by another company. My feature is written in Swift while the main app is in Objective-C. No biggie there – the bridging between the two works great. However, my feature is built as a dynamic framework and it has framework dependencies itself. When I add the framework by itself to the Objective-C application, I can run in the simulator but not on the device. The crash I sometimes get is often nothing more than below, with no messages in the console window:</p><pre class=language-nasm><code class=language-nasm>dyld`__abort_with_payload:
    <span class="token number">0x4f53cc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span>:  mov    <span class="token register variable">r12</span>, <span class="token register variable">sp</span>
    <span class="token number">0x4f53d0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span>:  push   {<span class="token register variable">r4</span>, <span class="token register variable">r5</span>, <span class="token register variable">r6</span>, <span class="token register variable">r8</span>}
    <span class="token number">0x4f53d4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span>:  ldm    <span class="token register variable">r12</span>, {<span class="token register variable">r4</span>, <span class="token register variable">r5</span>, <span class="token register variable">r6</span>}
    <span class="token number">0x4f53d8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span>: mov    <span class="token register variable">r12</span>, #<span class="token number">512</span>
    <span class="token number">0x4f53dc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>: orr    <span class="token register variable">r12</span>, <span class="token register variable">r12</span>, #<span class="token number">9</span>
    <span class="token number">0x4f53e0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">20</span><span class="token operator">></span>: svc    #<span class="token number">0x80</span>
<span class="token operator">-</span><span class="token operator">></span>  <span class="token number">0x4f53e4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">24</span><span class="token operator">></span>: pop    {<span class="token register variable">r4</span>, <span class="token register variable">r5</span>, <span class="token register variable">r6</span>, <span class="token register variable">r8</span>}
    <span class="token number">0x4f53e8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">></span>: blo    <span class="token number">0x4f5400</span>                  <span class="token comment">; &lt;+52></span>
    <span class="token number">0x4f53ec</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">32</span><span class="token operator">></span>: ldr    <span class="token register variable">r12</span>, <span class="token operator">[</span>pc, #<span class="token number">0x4</span><span class="token operator">]</span>           <span class="token comment">; &lt;+44></span>
    <span class="token number">0x4f53f0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">36</span><span class="token operator">></span>: ldr    <span class="token register variable">r12</span>, <span class="token operator">[</span>pc, <span class="token register variable">r12</span><span class="token operator">]</span>
    <span class="token number">0x4f53f4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">></span>: b      <span class="token number">0x4f53fc</span>                  <span class="token comment">; &lt;+48></span>
    <span class="token number">0x4f53f8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">44</span><span class="token operator">></span>: andeq  <span class="token register variable">r9</span>, <span class="token register variable">r0</span>, <span class="token register variable">r8</span>, lsl #<span class="token number">27</span>
    <span class="token number">0x4f53fc</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">></span>: <span class="token register variable">bx</span>     <span class="token register variable">r12</span>
    <span class="token number">0x4f5400</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">52</span><span class="token operator">></span>: <span class="token register variable">bx</span>     lr
</code></pre><p>Other times, I get text in the console complaining about an unsigned framework, with the framework name being one of the frameworks embedded in my own:</p><pre class=language-log><code class=language-log><span class="token property">dyld:</span> <span class="token property">Library not loaded:</span> <span class="token operator">@</span>rpath<span class="token operator">/</span>Siesta<span class="token punctuation">.</span>framework<span class="token operator">/</span>Siesta
  <span class="token property">Referenced from:</span> <span class="token file-path string">/private/var/containers/Bundle/Application/6370F0D4-4D48-4EBF-82DC-2E63EB421341/Nedbank.app/Frameworks/TaskMe.framework/TaskMe</span>
  <span class="token property">Reason:</span> no suitable image found<span class="token punctuation">.</span>  Did find<span class="token operator">:</span>
    <span class="token file-path string">/private/var/containers/Bundle/Application/6370F0D4-4D48-4EBF-82DC-2E63EB421341/Nedbank.app/Frameworks/TaskMe.framework/Frameworks/Siesta.framework/Siesta</span><span class="token operator">:</span> required code signature missing for <span class="token string">'/private/var/containers/Bundle/Application/6370F0D4-4D48-4EBF-82DC-2E63EB421341/Nedbank.app/Frameworks/TaskMe.framework/Frameworks/Siesta.framework/Siesta'</span>
</code></pre><p>Note that I had previously updated the <em>Runpath Search Paths</em> build setting value with <code>$executable_path/Frameworks/TaskMe.framework/Frameworks</code> so that the dynamic linker would see into my custom framework. However, clearly the code signing stage that takes place automatically in Xcode does not descend into such embedded frameworks. Fortunately a quick look at a build log shows what needs to take place:</p><pre class=language-console><code class=language-console><span class=command-line-prompt><span data-prompt=%></span></span><span class=command-line-command>/usr/bin/codesign --force --deep --sign &quot;${EXPANDED_CODE_SIGN_IDENTITY}&quot; --entitlements &quot;${TARGET_TEMP_DIR}/${PRODUCT_NAME}.app.xcent&quot; --timestamp=none &lt;FILE&gt;</span></code></pre><p>Here <code>&lt;FILE&gt;</code> is the object to sign, such as a framework.</p><h2>Deep into Nothing</h2><p>The man page for <code>codesign</code> documents a flag called <code>--deep</code> which seems like the perfect match for this problem. Unfortunately, the codesign step is not configurable as far as I can tell. Natch.</p><h2>A New Hope (in a Build Phase)</h2><p>Fortunately, Xcode does allow for build customization in the Build Phases tab of a target, and one such customization option is the ability to run a shell script. I created a new one with the following content that signs each of the embedded frameworks in my own framework:</p><pre class=language-bash><code class=language-bash><span class="token function">pushd</span> <span class="token variable">${TARGET_BUILD_DIR}</span>/<span class="token variable">${PRODUCT_NAME}</span>.app/Frameworks/TaskMe.framework/Frameworks
<span class="token keyword">for</span> <span class="token for-or-select variable">EACH</span> <span class="token keyword">in</span> *.framework<span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"-- signing <span class="token variable">${EACH}</span>"</span>
    /usr/bin/codesign --force --deep --sign <span class="token string">"<span class="token variable">${EXPANDED_CODE_SIGN_IDENTITY}</span>"</span> --entitlements <span class="token string">"<span class="token variable">${TARGET_TEMP_DIR}</span>/<span class="token variable">${PRODUCT_NAME}</span>.app.xcent"</span> --timestamp<span class="token operator">=</span>none <span class="token variable">$EACH</span>
<span class="token keyword">done</span>
<span class="token function">popd</span>
</code></pre><p>Here we move into the <code>Frameworks</code> directory of my own framework called <code>TaskMe</code> and I iterate over all <code>*.framework</code> entities found there. Each one gets the <code>codesign</code> treatment using the same parameter settings that I found in the original build log. Note that the <code>--deep</code> flag above is left-over from my other attempts – these embedded-embedded frameworks do not have any frameworks of their own to sign, so <code>--deep</code> is useless here.</p><p>A quick clean and rebuild, and my app runs fine on my device.</p><h2>Conclusion</h2><p>I feel confident that this addition to the build process is kosher, but there is always a chance that future changes to Xcode iOS building will break it – or render it obsolete. There is an alternative approach which also works: embed all embedded frameworks in the top-level target. However, I am less enamored with this approach due to the fact that if I add or remove a framework from my own, I have to remember to do the same with the top-level app target. With my ‘Build Process’ script, this is handled for me auto-magically.</p></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Signing%20Embedded%20Frameworks%20in%20an%20Embedded%20Framework&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fsigning%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fsigning%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/vhtc/animation.gif)" href=/articles/vhtc/index.html><section class=post><h2>Variable Height UITableView Cells in Swift</h2><div class=post-meta>Documents code necessary to achieve fast variable-height cells that use Auto Layout</div></section></a><a class="read-next-story prev" style="background-image: url(/articles/cocoapods/image.png)" href=/articles/cocoapods/index.html><section class=post><h2>Framework Bundles in Xcode and CocoaPods</h2><div class=post-meta>Short discussion about an issue I had fetching a bundle in Xcode and CocoaPods</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2017</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>