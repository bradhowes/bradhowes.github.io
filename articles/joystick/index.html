<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>JoyStickView for iOS in Swift | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Documents how I implemented a joy stick control view for a Swift iOS project"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/joystick/animation.gif)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >JoyStickView for iOS in Swift</a></h1><section class=post-meta><time class=post-date datetime="Tue Dec 06 2016 11:18:02 GMT+0100 (Central European Standard Time)">Dec 6th, 2016</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/swift.html>Swift (10)</a> • <a class=post-date href=/topics/ui.html>UI (5)</a></section></header><section class=post-content><p>I’ve been working on implementing a version of an old arcade game in Swift. The original game uses a joystick to move a character around on the screen, and I wanted a similar control but using touch for iOS devices. This has been done before of course, but I have always disliked how the base of the joystick was fixed, requiring the player to adapt to the position of the joystick. I wanted to joystick to adapt to the player’s hand in order to offer a more comfortable playing position.</p><h2>Joy of Sticks</h2><p>A mechanical joystick usually reports one or two pieces of information:</p><ul><li>some indication of the direction the handle is pointing (angle)</li><li>optionally, some measure of how far from the center the handle moved (displacement)</li></ul><p>For my game, I only need the first piece of information, but I designed the <code>JoyStickView</code> interface to provide both. The <code>JoyStickView</code> class stores these movement information in two read-only properties:</p><ul><li><code>angle</code> — the orientation of the handle, in units of degrees with 0° pointing up and 90° pointing to the right.</li><li><code>displacement</code> — how far from the center the handle moved, from 0.0 to 1.0 with the latter being the radius of the joystick base.</li></ul><p>The <code>JoyStickView</code> class also offers a <code>monitor</code> property which accepts a function which takes two arguments of <code>CGFloat</code> type. When set, the view will call the function passing in the current angle and displacement values when the values change from the last report. For instance, the <code>proc</code> below will print out to the console the angle and displacement values when they change:</p><pre class=language-swift><code class=language-swift><span class="token keyword">let</span> view <span class="token operator">=</span> <span class="token class-name">JoyStickView</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> proc <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>angle <span class="token class-name">CGFloat</span><span class="token punctuation">,</span> displacement <span class="token class-name">CGFloat</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token function">print</span><span class="token punctuation">(</span>"<span class="token punctuation">\</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span> <span class="token punctuation">\</span><span class="token punctuation">(</span>displacement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
view<span class="token punctuation">.</span>monitor <span class="token operator">=</span> proc
</code></pre><h2>Movement Calculations</h2><p>The operational guts of the <code>JoyStickView</code> class resides in its <code>updateLocation</code> method. This function takes in a <code>CGPoint</code> value which is expressed in the coordinate system of the view’s <em>parent</em> — we operate in the parent’s coordinate system to make our calculations easier.</p><p>First, we make sure that view and the touch location are usable, Next we calculate a displacement value from the deltas between the joystick center and the handle center:</p><pre class=language-swift><code class=language-swift><span class="token keyword">guard</span> <span class="token keyword">let</span> superview <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>superview <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
<span class="token keyword">guard</span> superview<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>

<span class="token comment">// Calculate displacements between given location and our frame's center</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> delta <span class="token operator">=</span> location <span class="token operator">-</span> frame<span class="token punctuation">.</span>mid

<span class="token comment">// Calculate normalized displacement</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> newDisplacement <span class="token operator">=</span> delta<span class="token punctuation">.</span>magnitude <span class="token operator">/</span> radius

<span class="token comment">// Calculate pointing angle used displacements. NOTE: using this ordering of dx, dy to atan2f to obtain</span>
<span class="token comment">// navigation angles where 0 is at top of clock dial and angle values increase in a clock-wise direction.</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> newAngleRadians <span class="token operator">=</span> <span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token class-name">Float</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span>dx<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Float</span><span class="token punctuation">(</span>delta<span class="token punctuation">.</span>dy<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><blockquote><p><strong>NOTE</strong>: the arguments to <code>atan2f</code> are swapped from the text book norm in order to obtain a north/up orientation for 0° with angle values increasing in a clock-wise direction.</p></blockquote><p><img src=Joystick_960.png title="" srcset="Joystick_480.png 480w,Joystick_650.png 650w,Joystick_960.png 960w,Joystick_1440.png 1440w" sizes="(min-width: 960px) 960px, calc(100vw-6rem)"></p><p>If the view supports moving the base, we need to calculate where the base should go. First, we calculate where on the perimeter of the base is the location of the handle image to keep the two separated by the radius of the base. From that point, we work backwards to locate the ideal base ‘center’ by simply subtracting from the original touch position the handle position and then radius of the base. Finally, if there is a <code>movableBounds</code> setting, we constrain the result to it so that the frame of the base always resides within it.</p><pre class=language-swift><code class=language-swift><span class="token comment">// Calculate point that should be on the circumference of the base image.</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> end <span class="token operator">=</span> <span class="token class-name">CGVector</span><span class="token punctuation">(</span>dx<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span><span class="token function">sinf</span><span class="token punctuation">(</span>newAngleRadians<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> radius<span class="token punctuation">,</span>
                   dy<span class="token punctuation">:</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span><span class="token function">cosf</span><span class="token punctuation">(</span>newAngleRadians<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> radius<span class="token punctuation">)</span>

<span class="token comment">// Calculate the origin of our frame, working backwards from the given location, and move to it.</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> origin <span class="token operator">=</span> location <span class="token operator">-</span> end <span class="token operator">-</span> <span class="token class-name">CGSize</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> radius<span class="token punctuation">,</span> height<span class="token punctuation">:</span> radius<span class="token punctuation">)</span>
<span class="token keyword">if</span> movableBounds <span class="token operator">!=</span> <span class="token nil constant">nil</span> <span class="token punctuation">{</span>
    frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token class-name">CGPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>x<span class="token punctuation">,</span> movableBounds<span class="token operator">!</span><span class="token punctuation">.</span>minX<span class="token punctuation">)</span><span class="token punctuation">,</span> movableBounds<span class="token operator">!</span><span class="token punctuation">.</span>maxX <span class="token operator">-</span> frame<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           y<span class="token punctuation">:</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>origin<span class="token punctuation">.</span>y<span class="token punctuation">,</span> movableBounds<span class="token operator">!</span><span class="token punctuation">.</span>minY<span class="token punctuation">)</span><span class="token punctuation">,</span> movableBounds<span class="token operator">!</span><span class="token punctuation">.</span>maxY <span class="token operator">-</span> frame<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> origin
<span class="token punctuation">}</span>
</code></pre><p>Finally, we set the handle position</p><pre class=language-swift><code class=language-swift><span class="token comment">// Update location of handle</span>
<span class="token comment">//</span>
handleImageView<span class="token punctuation">.</span>center <span class="token operator">=</span> bounds<span class="token punctuation">.</span>mid <span class="token operator">+</span> delta
</code></pre><p>The code for the <em>fixed</em> joystick base is considerably simpler. We only need to make sure that the handle’s center does not move further away from the joystick base than the radius of the base:</p><pre class=language-swift><code class=language-swift><span class="token comment">// Update location of handle</span>
<span class="token comment">//</span>
<span class="token keyword">if</span> newDisplacement <span class="token operator">></span> <span class="token number">1.0</span> <span class="token punctuation">{</span>

    <span class="token comment">// Keep handle on the circumference of the base image</span>
    <span class="token comment">//</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span><span class="token function">sinf</span><span class="token punctuation">(</span>newAngleRadians<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> radius
    <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span><span class="token function">cosf</span><span class="token punctuation">(</span>newAngleRadians<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> radius
    handleImageView<span class="token punctuation">.</span>frame<span class="token punctuation">.</span>origin <span class="token operator">=</span> <span class="token class-name">CGPoint</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> x <span class="token operator">+</span> bounds<span class="token punctuation">.</span>midX <span class="token operator">-</span> handleImageView<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">,</span>
                                           y<span class="token punctuation">:</span> y <span class="token operator">+</span> bounds<span class="token punctuation">.</span>midY <span class="token operator">-</span> handleImageView<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>
    handleImageView<span class="token punctuation">.</span>center <span class="token operator">=</span> bounds<span class="token punctuation">.</span>mid <span class="token operator">+</span> delta
<span class="token punctuation">}</span>
</code></pre><p>After the graphical positioning above, we finally update the angle and displacement values and call any installed monitor procedure. Note that we set <code>angle</code> to 0° if the handle is in the center of the base.</p><pre class=language-swift><code class=language-swift><span class="token comment">// Update joystick reporting values</span>
<span class="token comment">//</span>
<span class="token keyword">let</span> newClampedDisplacement <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>newDisplacement<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> newClampedDisplacement <span class="token operator">!=</span> displacement <span class="token operator">||</span> newAngleRadians <span class="token operator">!=</span> lastAngleRadians <span class="token punctuation">{</span>
    displacement <span class="token operator">=</span> newClampedDisplacement
    lastAngleRadians <span class="token operator">=</span> newAngleRadians

    <span class="token comment">// Convert to degrees: 0° is up, 90° is right, 180° is down and 270° is left</span>
    <span class="token comment">//</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>angle <span class="token operator">=</span> newClampedDisplacement <span class="token operator">!=</span> <span class="token number">0.0</span> <span class="token operator">?</span> <span class="token class-name">CGFloat</span><span class="token punctuation">(</span><span class="token number">180.0</span> <span class="token operator">-</span> newAngleRadians <span class="token operator">*</span> <span class="token number">180.0</span> <span class="token operator">/</span> <span class="token class-name">Float</span><span class="token punctuation">.</span>pi<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0.0</span>
    monitor<span class="token operator">?</span><span class="token punctuation">(</span>angle<span class="token punctuation">,</span> displacement<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><h2>Code</h2><p>The source code for my <code>JoyStickView</code> class is found as part of a <a href=https://github.com/bradhowes/Joystick>Xcode Swift playground</a> on GitHub. See the <a href=https://github.com/bradhowes/Joystick>README</a> there for details on the playground content and the <a href=https://github.com/bradhowes/Joystick/blob/master/Joystick.playground/Sources/JoyStickView.swift>JoyStickView.swift</a> in particular.</p></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=JoyStickView%20for%20iOS%20in%20Swift&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fjoystick%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fjoystick%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/articles/dependencyInjection/dependency-injection.png)" href=/articles/dependencyInjection/index.html><section class=post><h2>Dependency Injection for iOS in Swift</h2><div class=post-meta>Documents how I implemented dependency injection in a Swift iOS project</div></section></a><a class="read-next-story prev" style="background-image: url(/articles/vhtc/animation.gif)" href=/articles/vhtc/index.html><section class=post><h2>Variable Height UITableView Cells in Swift</h2><div class=post-meta>Documents code necessary to achieve fast variable-height cells that use Auto Layout</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2016</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>