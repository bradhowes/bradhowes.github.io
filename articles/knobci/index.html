<!DOCTYPE html><html lang=en-US><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Swift Snapshot Testing in Github Actions | Keystroke Countdown</title><meta name=author content="[object Object]"><meta name=robots content="index, follow"><meta name=HandheldFriendly content=True><meta name=description content="Short discussion on how I run snapshot tests in Github CI"><link rel=author href=/humans.txt><link rel=icon type=image/png href=/images/favicon.png><link rel=stylesheet href=/css/all-219136742a6fdee2bdc61d07f9ed89cc.css></head><body class="post-template nav-closed"><div class="nav nav-closed" id=nav><h3 class=nav-title>Menu</h3><a href=# class=nav-close><span class=hidden>Close</span></a><ul class=nav-list><li class=nav-home role=presentation><a href=/ ><i class="fa fa-home" aria-hidden=true></i> Home</a></li><li class=nav-home role=presentation><a href=/about><i class="fa fa-info-circle" aria-hidden=true></i> About Me</a></li><li class=nav-nome role=presentation><a href=/rss.xml><i class="fa fa-rss" aria-hidden=true></i> Subscribe</a> <a href="https://validator.w3.org/feed/check.cgi?url=https%3A//keystrokecountdown.com/rss.xml"><img src=/images/valid-rss-rogers.png alt="[Valid RSS]" title="Validate my RSS feed"></a></li><li class=nav-home role=presentation><a href=/topics><i class="fa fa-tags" aria-hidden=true></i> Topics</a></li><br><li class=nav-home role=presentation><a href=/articles/auv3/index.html>AUv3 Development -- Part 1 of N</a></li><li class=nav-home role=presentation><a href=/articles/knobci/index.html>Swift Snapshot Testing in Github Actions</a></li><li class=nav-home role=presentation><a href=/articles/wma/index.html>Converting WMA Files to MP3</a></li><li class=nav-home role=presentation><a href=/articles/remarkable/index.html>Remarkable Customizations</a></li><li class=nav-home role=presentation><a href=/articles/browsers/index.html>Automatic Browser Selection</a></li><li class=nav-home role=presentation><a href=/articles/genart/index.html>Generative Images with SVG.js</a></li><li class=nav-home role=presentation><a href=/articles/logistic/index.html>Simple Image Classification using Logistic Regression</a></li><li class=nav-home role=presentation><a href=/articles/kerberos/index.html>Using Kerboros on macOS</a></li><li class=nav-home role=presentation><a href=/articles/translate/index.html>Text Language Translation Utility</a></li><li class=nav-home role=presentation><a href=/articles/keymaps/index.html>Remapping Keys on macOS High Sierra</a></li><li class=nav-home role=presentation><a href=/articles/letencrypt/index.html>Fixing Azure Let&#x27;s Encrypt Expired Key</a></li><li class=nav-home role=presentation><a href=/articles/console/index.html>Formatting Console Output</a></li><li class=nav-home role=presentation><a href=/articles/layout/index.html>[DRAFT] Test Page for CSS Settings</a></li><li class=nav-home role=presentation><a href=/articles/docker/index.html>[DRAFT] Playing with .Net Core Apps and Docker on a Mac</a></li><li class=nav-home role=presentation><a href=/articles/autohotkey/index.html>Different (Key)strokes for Different Folks</a></li><li class=nav-home role=presentation><a href=/articles/itunes/index.html>Apple iTunes Library Manipulation with Python</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith2/index.html>Metalsmith Plugins for Server-side KaTeX Processing</a></li><li class=nav-home role=presentation><a href=/articles/poisson/index.html>Arrival Intervals of a Poisson Process</a></li><li class=nav-home role=presentation><a href=/articles/cocoapods/index.html>Framework Bundles in Xcode and CocoaPods</a></li><li class=nav-home role=presentation><a href=/articles/signing/index.html>Signing Embedded Frameworks in an Embedded Framework</a></li><li class=nav-home role=presentation><a href=/articles/vhtc/index.html>Variable Height UITableView Cells in Swift</a></li><li class=nav-home role=presentation><a href=/articles/joystick/index.html>JoyStickView for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/dependencyInjection/index.html>Dependency Injection for iOS in Swift</a></li><li class=nav-home role=presentation><a href=/articles/corePlot/index.html>Working with Core Plot</a></li><li class=nav-home role=presentation><a href=/articles/slidingViews/index.html>Sliding UIViews with Core Animation</a></li><li class=nav-home role=presentation><a href=/articles/swiftCollection/index.html>Adding Binary Search to Swift Collections</a></li><li class=nav-home role=presentation><a href=/articles/metalsmith/index.html>Metalsmith Static Site on Azure</a></li><li class=nav-home role=presentation><a href=/articles/bloom/index.html>Bloom Filters in Python</a></li><li class=nav-home role=presentation><a href="/articles/Testing IPython/testing-ipython.html">Testing IPython</a></li><li class=nav-home role=presentation><a href=/articles/decrypt/index.html>Decrypting Logs in Python</a></li><li class=nav-home role=presentation><a href=/articles/power/index.html>Power of Optimal Algorithm Design</a></li><li class=nav-home role=presentation><a href=/articles/PDMPlayground/index.html>PDM Playground</a></li><li class=nav-home role=presentation><a href=/articles/bscope/index.html>B-Scope Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/ascope/index.html>A-Scope Signal Display</a></li><li class=nav-home role=presentation><a href=/articles/radardisplay/index.html>Radar Display</a></li><li class=nav-home role=presentation><a href=/articles/dfwtraffic/index.html>Visualizing Traffic at DFW Airport</a></li></ul></div><span class=nav-cover></span><div class=site-wrapper><header class="main-header post-head" style="background-image: url(/articles/knobci/computer-keyboard-stones-on-grass-background-header.jpg)"><nav class="main-nav overlay clearfix"><a class="menu-button icon-menu" href=#><span class=word>Menu</span></a></nav></header><main class=content role=main><article class=post><header class=post-header><h1 class=post-title><a href=/ >Swift Snapshot Testing in Github Actions</a></h1><section class=post-meta><time class=post-date datetime="Sun Mar 05 2023 10:06:00 GMT+0100 (Central European Standard Time)">Mar 5th, 2023</time> <a class=post-date href=/topics><i class="fa fa-tags" aria-hidden=true></i></a> <a class=post-date href=/topics/ci.html>CI (1)</a> • <a class=post-date href=/topics/github.html>Github (1)</a> • <a class=post-date href=/topics/swift.html>Swift (10)</a></section></header><section class=post-content><p>I have a Swift package called <a href=http://github.com/bradhowes/Knob>Knob</a> that creates a circular knob control for iOS and macOS (and apparently tvOS too). For testing, I use the excellent <a href=http://github.com/pointfreeco/swift-snapshot-testing>SnapshotTesting</a> package from <a href=https://pointfree.co>Point•Free</a> that supports a nice collection of testable types like <code>NSView</code> and <code>UIView</code>, and artifact representations such as PNG representations from those views. It works great on my laptop, but when run on Github, the tests fail because the PNG images that the tests generate are not of the same format as they are on my laptop. This is primarily due to Retina scaling, though there could also be colorspace issues and rendering environments (Metal vs CPU) coming into play as well.</p><p>The key to making the tests work in a Github continuous-integration (CI) workflow is to partition the snapshot artifacts into those that come from a dev environment such as my laptop, and those that comee from Github workflow. To that end, I followed a comment made by another user of the SnapshotTesting library and modified the artifact names based on the environment the test was running in. Here is the function I use to assert that the rendering of my test knob is the same as before:</p><pre class=language-swift><code class=language-swift>  <span class="token keyword">func</span> <span class="token function-definition function">assertSnapshot</span><span class="token punctuation">(</span>file<span class="token punctuation">:</span> <span class="token class-name">StaticString</span> <span class="token operator">=</span> <span class="token literal constant">#file</span><span class="token punctuation">,</span> testName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token operator">=</span> <span class="token literal constant">#function</span><span class="token punctuation">,</span> line<span class="token punctuation">:</span> <span class="token class-name">UInt</span> <span class="token operator">=</span> <span class="token literal constant">#line</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
    knob<span class="token punctuation">.</span><span class="token function">layoutSubtreeIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    knob<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> snapshotEnv <span class="token operator">=</span> <span class="token class-name">ProcessInfo</span><span class="token punctuation">.</span>processInfo<span class="token punctuation">.</span>environment<span class="token punctuation">[</span><span class="token string-literal"><span class="token string">"SNAPSHOT_ENV"</span></span><span class="token punctuation">]</span> <span class="token operator">??</span> <span class="token string-literal"><span class="token string">"dev"</span></span>
    <span class="token keyword">let</span> failure <span class="token operator">=</span> <span class="token function">verifySnapshot</span><span class="token punctuation">(</span>matching<span class="token punctuation">:</span> knob<span class="token punctuation">,</span>
                                 <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span>precision<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span> perceptualPrecision<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 named<span class="token punctuation">:</span> snapshotEnv<span class="token punctuation">,</span>
                                 record<span class="token punctuation">:</span> isRecording<span class="token punctuation">,</span>
                                 snapshotDirectory<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span>
                                 file<span class="token punctuation">:</span> file<span class="token punctuation">,</span>
                                 testName<span class="token punctuation">:</span> testName<span class="token punctuation">,</span>
                                 line<span class="token punctuation">:</span> line<span class="token punctuation">)</span>
    <span class="token keyword">guard</span> <span class="token keyword">let</span> message <span class="token operator">=</span> failure <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>
    <span class="token class-name">XCTFail</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> file<span class="token punctuation">:</span> file<span class="token punctuation">,</span> line<span class="token punctuation">:</span> line<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre><p>The start of the method asks the knob to render itself prior to being used for a snapshot – for some reason on Github without this I was seeing blank snapshots, and my tests were not exercising some custom <code>NSBezierPath</code> routines.</p><p>The Github CI workflow script set the <code>SNAPSHOT_ENV</code> value to be “ci” before it starts the bnild and test stage of the workflow:</p><pre class=language-yaml><code class=language-yaml>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and Test
      <span class="token key atrule">run</span><span class="token punctuation">:</span> make
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">SNAPSHOT_ARTIFACTS</span><span class="token punctuation">:</span> <span class="token string">"$PWD/.snapshots"</span>
        <span class="token key atrule">SNAPSHOT_ENV</span><span class="token punctuation">:</span> ci
</code></pre><p>It also sets <code>SNAPSHOT_ARTIFACTS</code> so that if the SnapshotTesting library detects a difference, it will save the artifact for the test failure in a location that we can use later on to upload to Github as a workflow artifact.</p><p>The ability to set <code>SNAPSHOT_ARTIFACTS</code> is nice, but unfortunately if the test failes because <em>no</em> artifact exists to compare against, the SnapshotTesting library ignores it and instead plops the image file into the repo location where it expected to find it, which is not very useful for me. To overcome this, I added a step in the CI workflow that saves the entire contents of this location if the test step failed:</p><pre class=language-yaml><code class=language-yaml>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy Snapshots
      <span class="token key atrule">if</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> failure() <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        mkdir .snapshots
        cp -r $(find . -name Knob-macOSTests)/__Snapshots__ .snapshots/</span>
</code></pre><p>Now, when a new test fails because there is not a “ci” tagged image, I can download the artifacts, locate the new “ci” image file and manually add it to the repo so that a subsequent commit will make it available for the CI tests. Not ideal, but it works well enough for the times when I add a new test case.</p><p>If tests fail because of differences fonund in an existing artifact, the SnapshotTesting framework will do the right thing and deposit the artifact from the failed test into the <code>SNAPSHOT_ARTIFACTS</code> directory. This allows me to evaluate the difference and hopefully fix why the test failed.</p><p>Finally, here is the CI step that uploads any image artifacts. Note that it only executes if the build/test stage fails, just like the copy step above.</p><pre class=language-yaml><code class=language-yaml>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload Snapshot Failures
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v3
      <span class="token key atrule">if</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> failure() <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> snapshots
        <span class="token key atrule">path</span><span class="token punctuation">:</span> .snapshots/
</code></pre><p>The entire CI script is viewable at <a href=https://github.com/bradhowes/Knob/blob/main/.github/workflows/CI.yml>CI.yaml</a></p></section><footer class=post-footer><figure class=author-image><a class=img href=https://keystrokecountdown.com style=background-image:url(/images/HarrisonsLaugh.png)><span class=hidden>Brad Howes's Picture</span></a></figure><section class=author><h4><a href=https://keystrokecountdown.com>Brad Howes</a></h4><p>Owner <a href=https://apps.apple.com/us/developer/b-ray-software/id430573224>B-Ray Software</a>. Programmer in C++, Swift, Python, Javascript and more. Started out doing punch cards in FORTRAN.</p><div class=author-meta><span class="author-location icon-location">Paris, France</span> <span class="author-link icon-link"><a href=http://linkedin.com/in/bradhowes>http://linkedin.com/in/bradhowes</a></span> <span class="author-link icon-feed"><a href=mailto:bradhowes@mac.com>&nbsp;Email Me</a></span></div></section><section class=share><h4>Share this page</h4><div class=social-icons><a class=icon-twitter href="https://twitter.com/intent/tweet?text=Swift%20Snapshot%20Testing%20in%20Github%20Actions&amp;url=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fknobci%2Findex.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;"><span class=hidden>Twitter</span> </a><a class=icon-feed href="mailto:bradhowes@mac.com?subject=Curiosity&body=https%3A%2Fkeystrokecountdown.com%2Farticles%2Fknobci%2Findex.html"><span class=hidden>Email</span></a></div></section></footer></article></main><aside class=read-next><a class=read-next-story style="background-image: url(/computer-keyboard-stones-on-grass-background-header.jpg)" href=/articles/wma/index.html><section class=post><h2>Converting WMA Files to MP3</h2><div class=post-meta>Using FFMpeg toolkit to transcode MWA files to MP3 format</div></section></a><a class="read-next-story prev" style="background-image: url(/articles/auv3/auv3.png)" href=/articles/auv3/index.html><section class=post><h2>AUv3 Development -- Part 1 of N</h2><div class=post-meta>Lame attempt to share what I&#x27;ve learned about AUv3 audio units</div></section></a></aside><footer class="site-footer clearfix"><section class=copyright><a href=https://keystrokecountdown.com>Keystroke Countdown</a> &copy; <span id=copyrightYear>2023</span> Brad Howes — <a href=https://github.com/bradhowes/keystrokecountdown>Source</a></section></footer></div><script>(function () {
      var installClickHandlers = function () {
        var navElement = document.getElementById("nav");
    
        // The click handler just toggles classes to do the showing/hiding
        //
        var clickHandler = function(e) {
          document.body.classList.toggle("nav-opened");
          document.body.classList.toggle("nav-closed");
          if (navElement) {
            navElement.classList.toggle("nav-opened");
            navElement.classList.toggle("nav-closed");
          }
        };
    
        // Find elements we wish to tap for click events
        //
        var elements = Array.prototype.slice.call(
          document.querySelectorAll(".menu-button, .nav-cover, .nav-close"));
        if (elements && elements.length > 0) {
          elements.forEach(function (element) {
            element.addEventListener('click', clickHandler);
          });
        }
      };
    
      // When the document is finished loading, install event handlers to show/hide sidebar menu
      //
      window.document.addEventListener("DOMContentLoaded", function (event) {
        installClickHandlers();
    
        // Set the copyright year at the bottom of our pages
        //
        window.document.getElementById("copyrightYear").innerHTML = (new Date()).getFullYear();
      });
    })();</script></body></html>